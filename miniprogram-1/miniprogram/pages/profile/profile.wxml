<!--pages/profile/profile.wxml-->
<view class="container">
  <!-- 顶部背景 -->
  <view class="top-bg">
    <view class="bg-pattern"></view>
    <view class="bg-gradient"></view>
  </view>

  <!-- 登录提示弹窗 -->
  <view wx:if="{{showLoginPrompt && !hasUserInfo}}" class="login-modal">
    <view class="modal-mask" bindtap="handleRejectLogin"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="welcome-icon">🌺</view>
        <text class="welcome-title">欢迎使用兰花识别</text>
        <text class="welcome-subtitle">登录后可享受更多个性化功能</text>
      </view>
      
      <view class="feature-list">
        <view class="feature-item">
          <view class="feature-icon">📚</view>
          <text class="feature-text">保存识别历史记录</text>
        </view>
        <view class="feature-item">
          <view class="feature-icon">❤️</view>
          <text class="feature-text">收藏喜欢的兰花</text>
        </view>
        <view class="feature-item">
          <view class="feature-icon">📊</view>
          <text class="feature-text">查看个人数据统计</text>
        </view>
      </view>
      
      <view class="modal-actions">
        <button 
          class="action-btn secondary-btn" 
          bindtap="handleRejectLogin"
        >
          暂不登录
        </button>
        <button 
          class="action-btn primary-btn {{isLoading ? 'loading' : ''}}" 
          bindtap="handleLogin"
          disabled="{{isLoading}}"
        >
          <view wx:if="{{isLoading}}" class="loading-spinner"></view>
          <text>{{isLoading ? '登录中...' : '微信登录'}}</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 用户信息卡片 -->
  <view class="user-card">
    <view wx:if="{{hasUserInfo}}" class="user-info-logged">
      <view class="avatar-section">
        <!-- 使用新的头像选择器 -->
        <button 
          class="avatar-button" 
          open-type="chooseAvatar" 
          bind:chooseavatar="onChooseAvatar"
        >
          <image class="avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view class="avatar-edit-hint">
            <text class="edit-text">点击更换</text>
          </view>
        </button>
        <view class="status-dot"></view>
      </view>
      <view class="user-content">
        <view class="user-main">
          <!-- 使用新的昵称输入框 -->
          <view class="nickname-wrapper">
            <input 
              wx:if="{{canIUseNicknameComp}}"
              class="nickname-input"
              type="nickname" 
              placeholder="请输入昵称"
              value="{{userInfo.nickName}}"
              bind:blur="onInputNickname"
            />
            <text wx:else class="username">{{userInfo.nickName}}</text>
          </view>
          <view class="user-badge">
            <text class="badge-text">VIP</text>
          </view>
        </view>
        <text class="user-desc">兰花识别专家 · 已识别{{stats.totalRecognitions}}种</text>
      </view>
      <view class="settings-btn" bindtap="handleLogout">
        <view class="settings-icon"></view>
      </view>
    </view>
    
    <view wx:else class="user-info-guest">
      <view class="guest-avatar">
        <view class="avatar-placeholder">
          <text class="avatar-text">🌸</text>
        </view>
      </view>
      <view class="guest-content">
        <text class="guest-title">体验兰花识别功能</text>
        <text class="guest-desc">无需登录即可使用基础识别功能</text>
        <button 
          class="login-button {{isLoading ? 'loading' : ''}}" 
          bindtap="handleLogin"
          disabled="{{isLoading}}"
        >
          <view wx:if="{{isLoading}}" class="loading-spinner"></view>
          <text>{{isLoading ? '登录中' : '登录解锁更多'}}</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 数据统计卡片 -->
  <view wx:if="{{hasUserInfo}}" class="stats-card">
    <view class="stats-header">
      <text class="stats-title">我的数据</text>
      <view class="stats-icon">📊</view>
    </view>
    <view class="stats-content">
      <view class="stat-item">
        <view class="stat-circle stat-primary">
          <text class="stat-number">{{stats.totalRecognitions}}</text>
        </view>
        <text class="stat-label">总识别</text>
      </view>
      <view class="stat-item">
        <view class="stat-circle stat-success">
          <text class="stat-number">{{stats.accurateRecognitions}}</text>
        </view>
        <text class="stat-label">准确识别</text>
      </view>
      <view class="stat-item">
        <view class="stat-circle stat-warning">
          <text class="stat-number">{{stats.favoriteCount}}</text>
        </view>
        <text class="stat-label">收藏</text>
      </view>
      <view class="stat-item">
        <view class="stat-circle stat-info">
          <text class="stat-number">{{stats.usageDays}}</text>
        </view>
        <text class="stat-label">使用天数</text>
      </view>
    </view>
  </view>

  <!-- 提示卡片（未登录状态） -->
  <view wx:else class="hint-card">
    <view class="hint-content">
      <view class="hint-icon">💡</view>
      <view class="hint-text">
        <text class="hint-title">温馨提示</text>
        <text class="hint-desc">登录后可保存识别记录、收藏兰花品种，享受更完整的使用体验</text>
      </view>
    </view>
  </view>

  <!-- 功能菜单 -->
  <view class="menu-section">
    <view class="section-header">
      <text class="section-title">我的功能</text>
      <view class="section-decoration"></view>
    </view>
    <view class="menu-grid">
      <view 
        class="menu-card {{!hasUserInfo ? 'menu-card-disabled' : ''}}" 
        wx:for="{{menuItems}}" 
        wx:key="id"
        data-item="{{item}}"
        bindtap="handleMenuItemTap"
      >
        <view class="menu-icon-wrapper">
          <image class="menu-icon" src="{{item.icon}}" mode="aspectFit"></image>
          <view wx:if="{{item.badge}}" class="menu-badge {{item.badge === 'new' ? 'badge-new' : 'badge-number'}}">
            {{item.badge}}
          </view>
          <view wx:if="{{!hasUserInfo}}" class="lock-overlay">
            <text class="lock-icon">🔒</text>
          </view>
        </view>
        <text class="menu-title">{{item.title}}</text>
        <view class="menu-arrow">→</view>
      </view>
    </view>
  </view>

  <!-- 设置菜单 -->
  <view class="settings-section">
    <view class="section-header">
      <text class="section-title">设置与帮助</text>
      <view class="section-decoration"></view>
    </view>
    <view class="settings-list">
      <view 
        class="setting-item" 
        wx:for="{{settingItems}}" 
        wx:key="id"
        data-item="{{item}}"
        bindtap="handleSettingItemTap"
      >
        <view class="setting-left">
          <view class="setting-icon-bg">
            <image class="setting-icon" src="{{item.icon}}" mode="aspectFit"></image>
          </view>
          <text class="setting-text">{{item.title}}</text>
        </view>
        <view class="setting-arrow">
          <text class="arrow-text">›</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部信息 -->
  <view class="footer">
    <view class="app-info">
      <view class="app-logo">🌺</view>
      <view class="app-details">
        <text class="app-name">智能兰花识别</text>
        <text class="app-version">v1.0.0</text>
      </view>
    </view>
    <text class="copyright">© 2024 技术支持 · 微信云开发</text>
  </view>

  <!-- 装饰元素 -->
  <view class="decoration decoration-1"></view>
  <view class="decoration decoration-2"></view>
  <view class="decoration decoration-3"></view>
</view>